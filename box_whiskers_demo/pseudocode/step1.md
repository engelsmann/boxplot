Django application
====
Here, we build a module for a larger dashboard to be used by a teacher
in the feedback dialogue with individual students.
Multiple performance indicators (PI) need to be included,
but in this demo, only the PI of assessment data from 
a single written assignment is included.

After
[changing the Git base directory](https://stackoverflow.com/a/1213449/888033)
locally and deleting the old GitBub repo, I succeeded in running
version control with 
[Git](https://git-scm.com/book/en/v2/Getting-Started-About-Version-Control).

Django's project and application
---
Once created, a Django **project** can contain one or more **applicaitons**, apps.
> I: [Create](https://docs.djangoproject.com/en/3.1/ref/django-admin/)
> by issuing this command from the place in 
> the file directory structure, where you want the (Git and)
> Django project to reside:

> `$ django-admin createproject box_whiskers_demo`

Within the Django *project* `box_whiskers_demo`, a 
[Django *application*](https://docs.djangoproject.com/en/3.1/intro/tutorial01/#creating-the-polls-app)
with three steps (*View*s, and thus *Templates*) is to be developed.
I'll give the demo app the name `boxplot`.
> II: From the project root directory, `box_whiskers_demo`:

> `$ python manage.py startapp boxplot `

Three step overview
---
The `boxplot` demo app will exhibit three pages to the User:
1. **Enter data** to the app:
   (Class, Students, detailed assessment data for one assignment).
1. For the `Klasse` and `Assignment` given (dropdowns), 
   **select a Student**, `Elev`, whose assessment data to display graphically.
   A set of **radio button**s interacts with the User.
1. Show assessment data for the selected Student.
   Student data (dots)  will be highlighted on a
   backdrop of the whole Class' distribution of assessment data (boxplots).
   This page should interact with the User through a **navigation button** back to Step 2
   or close window.

Possibly the main template may contain **demo**-style links to this GitHub repo
and the like for personal branding of the developers.

Step 1: Data entered into system
---
- Not needed in the minimal first version: 
  - ~~Link to a valid CSV file, the user can download for demo purposes~~.
  - ~~Upload button for CSV file~~.
  - ~~Safely read CSV file from 
    [`HttpRequest.FILES` list](https://docs.djangoproject.com/en/3.1/ref/request-response/#django.http.HttpRequest.FILES)
    and store it in database~~.

  (Spared for refoactoring process).
- Database in Django are [`models.py`](../../boxplot/models.py). 
  Database tables are instantiated from `models.Model`, and the columns in these tables,
  [fields](https://docs.djangoproject.com/en/3.1/ref/models/fields/#field-types),
  describe the data and may connect tables (field class `ForeignKey`, here the required 
  [parameer `on_delete`](https://docs.djangoproject.com/en/3.1/ref/models/fields/#django.db.models.ForeignKey.on_delete)).
  Tilsvarende er de objekter, der passer i et `DateField` af Python-typen 
  [`datetime.date`](https://docs.python.org/2/library/datetime.html#date-objects).
  Models must be **activated**, and this happens by 
  1. [adding](https://docs.djangoproject.com/en/3.1/intro/tutorial02/#activating-models)
  the `BoxplotConfig` from [`apps.py`](../../boxplot/apps.py) 
  1. to the list `INSTALLED_APPS` in [`settings.py`](../settings.py).
  1. Then, we can let Django do *migrations* - changes to our database schema:
     > `$ python manage.py makemigrations boxplot`
     
     And then 
     > `$ python manage.py migrate`

     to actually carry out the migrations (instruction files) generated by `makemigrations`.
   1. In an `{% if %}` tag of the `templates/boxplot/index.html` **template**, we use the
      [`slugify`](https://docs.djangoproject.com/en/3.0/ref/templates/builtins/#slugify)
      filter in order to compare the `id` attribute of the `QuerySet` 
      element, named `samtalepartner.id`. 
      We can only compare this **integer** by equality, `==`, with 
      the **string** provided by FORM variable `elev`, after this **filtering** (conversion).
      Within the Django template's scope, where the comparison is made,
      `Elev.id` lives in template variable `request.POST.elev`.
      (In the FORM, the input field of `type="radio"` attributed `name="elev"`
      takes the value `Elev.id`, the table's primary key).
   1. In order to **use** the `AssessmentScore` data, 
      **the related Django Model needs to be populated**.
      To carry out this
      [ETL](https://en.wikipedia.org/wiki/Extract,_transform,_load)
      workflow, I want to use the `admin/` pages, so I head over to
      http://127.0.0.1:8000/admin/ and log in.
      But I can't use the Model's `admin/` page, as I want to **import**,
      I do not want to key in all individual data...
      Therefore, I turn to [pandas](https://pandas.pydata.org/).
      The entire, rather hand held ETL process is documented in the
      [`data_import.py` file](.../../data_import.py).
      Quite a lot of the ETL was done, however, in R, and the script responsible 
      for that piece of work is `ETL+pres-COVID-aflevering.R`.
      What is needed in ETL, is:
      - Read CSV (Pandas) file `cov-11x51-2f.csv` with 11 submissions.
        Names must be altered due to data protection.
      - In a `while` loop, `cycle` CSV data rows on registered `Elev` entries
        filtered for `Klasse.navn=='1test'`.
        The result of this will be the QuerySet
        `AssessmentScore.object.filter(klasse=Klasse.object.filter(Klasse.navn='1test').id)`.
      - This QuerySet must then be imported to Django project.
        That is, data from the CSV file for assessment scores of the assignment
        are imported to Python and stored as `Elev` and `AssessmentScore`, respectively.
        The importation is recorded in the file 
        [data_import_assigment.py](../../data_import_assigment.py)
      - The Django data, then must be prepared to produce a
        [matplotlib.boxplot](https://matplotlib.org/api/_as_gen/matplotlib.pyplot.boxplot.html)
        plot, to use as background for the presentations of
        individual student performances, and thus a **storing mechanism**
        for the plot must be chosen, in order for it to be retrieved quickly.
        Options include 
        [`pickle`](https://docs.python.org/3/library/pickle.html), 
        [LRU](https://realpython.com/lru-cache-python/), or
        a 
        [cache `dict`](https://www.blog.pythonlibrary.org/2016/02/25/python-an-intro-to-caching/),
        but are not limited the these ones.
      - Finally (meaning *ready for functional testing*),
        the selected student's performance is overlaid,
        and the entire, glorious result is presented on in separate
        Django View
        (with back reference to the `index` to select another student).


     
- Show button "Proceed to student selection" ([step 2](./step2.md))

`$ python manage.py runserver` gives me a neat Django
[landing page](http:::127.0.0.1:8000 "Development server, local machine only"),
and from here, I continue tracking the 
[Django tutorial](https://docs.djangoproject.com/en/3.1/intro/tutorial02/ "Part 2").

### Documentation in `pydoc` - from DocStrings
Python documentation should follow
[PEP 257](https://www.python.org/dev/peps/pep-0257/)
on "Docstring Conventions".   

When trying to extract documentation from `foo.py` using `pydoc` e.g. as
`$  pydoc foo`, I get the desired outcome, 
while `$  pydoc foo.py` give me an error.

When trying to extract documentation using `pydoc` e.g. as
`boxplot$  pydoc models.py`,
I get 
> ImproperlyConfigured: Requested setting INSTALLED_APPS ...

Following [this advice](https://stackoverflow.com/a/50075525/888033),
I therefore tried `pydoc` in the IPython prompt served up by
`$ python manage.py shell`.
- How do I run `pydoc` from **within a Python prompt**?
  > Check out [this SO answer](https://stackoverflow.com/a/61879712/888033)

I refreshed my knowledge by following this DataCamp 
[course on functions](https://campus.datacamp.com/courses/writing-functions-in-python/best-practices)
(chapter 1), and 

NB: Alternatives to `pydoc` include: 
- [`admindocs`](https://docs.djangoproject.com/en/3.1/ref/contrib/admin/admindocs/)
  from Django.
- [reStructuredText](https://docutils.sourceforge.io/rst.html), 
  which is nicely presented by Bryson in
  [this 2018 pyCon presentation](https://youtu.be/JQ8RQru-Y9Y),
  including mentioning the Sphinx > GitHub > Read the Docs pipe.
- In the `docstring` you can put simple (unit) testing and 
  run the test using 
  [the Doctest module](https://docs.pytest.org/en/stable/doctest.html).

Best practice in function design
---
Inspired by the above mentioned Datacamp course:
- DRY: Don't repeat yourself.
- DOT: Do one thing.
 [Refactor](https://martinfowler.com/books/refactoring.html)
 existing code, if needed, to live up to the DRY and DOT principles.

Test suite
---
But I also have to locate in which script files to put the following tests.
In terms of certification, [pydoc](https://docs.python.org/3/library/pydoc.html) 
shows up but also [doctest](https://docs.pytest.org/en/stable/doctest.html).
However, now my
[MS 98-381 exam](https://www.youracclaim.com/badges/d9115396-6c02-4a09-b35a-2d068321f36f "Just bragging :-)")
on fundamentals of Python is passed, and the 
[Django testing facilities](https://docs.djangoproject.com/en/3.1/intro/tutorial05/)
seem more relevant.

For functional tests (`Selenium` based), it was paramount to run the 
test scripts **outside** Visual Studio Code. 
Running `$ python my_test_script.py` in system (not VSC) terminal got me going with
automated-browser-based testing.
1. Link to the proposed data file is formed properly as HTML:
   Anchor, `<a `...`href="`URL`"`...`>`txt`</a>`.
   - [Directive](https://docs.python.org/3/library/doctest.html#doctest-directives)
     to `doctest`: `+ELLIPSIS`, allowing `...` in test.
   - Functional test (`Selenium`):
     Are we actually served a file on clicking the link?
1. Link to data file points to file
   - URL starts `file://`
1. Link to data file points to file of type CSV
   - URL ends `.csv`
1. Link to data file points to correct file
   - File must be named `sample-class-sample-assignment.csv` 
1. Button to upload file accepts files
   - FORM field type ___
   - Functional test
     (Selenium) Success indicator upon non-failed file upload?
1. (Uploaded file rejected if extension not CSV)
   - Upon attempted upload, ...
   - Functional test:
     (Selenium) Failure indicator upon failed file upload?
1. ~~Uploaded file rejected if file encoding not UTF-8~~ (?)
1. Uploaded file rejected if columns count is not 2+2+6+6=16:
   (class + student name + 
   assignment title + asignment deadline +
   6 excercises + 6 learning objectives)
   - Test `len(col_name_list)==16`
1. Uploaded file rejected if column headers are **not** as tuple of strings (expected col heads)
   - [Convert list of col names to tuple](https://www.geeksforgeeks.org/python-convert-a-list-into-a-tuple/)
     and compare: `tuple(col_name_list)==expedted_col_heads`
1. Uploaded file **accepted** if column headers **are** as tuple of strings (expected col heads)
   - What happens upon acceptance? Look for indicator ...
1. Uploaded file rejected if data in rows does **not** conform to model data types
   - How are CSV data transformed to (NumPy) array / (pandas) DataFrame?
   - How are array columns matched to database columns?
1. Uploaded file accepted if data in rows does conform to model data types
   - What happens upon acceptance? Look for indicator ...
1. Uploaded file rejected if missing data cells
   - [Function `isnan()`](https://numpy.org/doc/stable/reference/generated/numpy.isnan.html)
     deployed ...
1. Uploaded file **accepted** if **no missing** data cells 
   - What happens upon acceptance? Look for indicator ...
   - 
1. All data (multiple rows) for a class of students can be read from database
   - What happens upon success? Look for indicator ...
   - 
1. Data (single row) for a identified student can be read from database
   - What happens upon success? Look for indicator ...
   - 
1. View change on acceptance of data: Button to proceed is shown.
   - Look for button
   - Button should point to next step URL
   - Functional test
     (Selenium)?
